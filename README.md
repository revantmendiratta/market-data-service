# Blockhouse Capital - Market Data Microservice

This project is a production-ready microservice built for the Blockhouse Capital work trial assignment. It demonstrates a robust, event-driven architecture designed to fetch, process, and serve real-time market data. The system features a FastAPI backend, a PostgreSQL database for persistence, and an Apache Kafka streaming pipeline for asynchronous processing of market events.

---

## Tech Stack

![Python](https://img.shields.io/badge/python-3.9-blue.svg?style=for-the-badge&logo=python)
![FastAPI](https://img.shields.io/badge/FastAPI-009688.svg?style=for-the-badge&logo=fastapi)
![PostgreSQL](https://img.shields.io/badge/postgresql-4169E1.svg?style=for-the-badge&logo=postgresql)
![Kafka](https://img.shields.io/badge/Apache%20Kafka-231F20.svg?style=for-the-badge&logo=apache-kafka)
![Docker](https://img.shields.io/badge/docker-2496ED.svg?style=for-the-badge&logo=docker)
![Pytest](https://img.shields.io/badge/pytest-0A9B71.svg?style=for-the-badge&logo=pytest)
![GitHub Actions](https://img.shields.io/badge/github%20actions-2088FF.svg?style=for-the-badge&logo=github-actions)

---

## Architecture

The system is designed around a decoupled, microservice-oriented architecture. An API service acts as the primary entry point, handling client requests and producing events. A separate consumer service listens for these events and performs computationally intensive tasks asynchronously. This ensures the API remains fast and responsive.

### System Architecture Diagram
*A high-level overview of the services and their connections. All services are containerized and managed by Docker Compose.*

***Note: You need to create this diagram and save it as `docs/system-architecture.png`***
![System Architecture](docs/system-architecture.png "System Architecture Diagram")

### Data Flow Diagram
*The sequence of events when fetching a new price for a stock symbol.*

***Note: You need to create this diagram and save it as `docs/data-flow.png`***
![Data Flow](docs/data-flow.png "Data Flow Diagram")

---

## Features

- **REST API:** A clean, documented API for fetching the latest stock prices.
- **Asynchronous Processing:** A Kafka pipeline decouples price fetching from data processing, ensuring high throughput and low latency.
- **Real-time Analytics:** A dedicated consumer calculates a 5-point moving average for any symbol as new price data streams in.
- **Containerized:** The entire application stack (API, consumer, database, Kafka) is fully containerized with Docker, allowing for one-command setup and consistent environments.
- **Automated Testing:** A comprehensive test suite using `pytest` validates both business logic and API functionality.
- **Continuous Integration:** A GitHub Actions workflow automatically lints and tests the codebase on every push to the main branch, ensuring code quality and reliability.

---

## Setup and Installation

### Prerequisites
- Docker Engine
- Docker Compose

### Running the Application

1.  **Clone the repository:**
    ```bash
    git clone <your-repo-url>
    cd market-data-service
    ```

2.  **Run with Docker Compose:**
    The following command will build the Docker images from scratch and start all five services (API, Consumer, Database, Kafka, Zookeeper).
    ```bash
    docker-compose up --build
    ```
    To run the services in the background (detached mode), use the `-d` flag:
    ```bash
    docker-compose up --build -d
    ```
    The API service will be available at `http://localhost:8000`.

---

## Usage Guide

### API Documentation
Once the application is running, full interactive API documentation is automatically generated by FastAPI and is available at:

- **Swagger UI:** [**http://localhost:8000/docs**](http://localhost:8000/docs)
- **ReDoc:** [**http://localhost:8000/redoc**](http://localhost:8000/redoc)

### Endpoints

- **`GET /prices/latest`**: Fetches the latest price for a given stock symbol. This endpoint saves the price to the database and triggers the Kafka pipeline.
  - **Example:** `http://localhost:8000/prices/latest?symbol=AAPL&provider=yahoo_finance`

- **`GET /prices/moving-average`**: Fetches the last calculated 5-point moving average for a given symbol.
  - **Example:** `http://localhost:8000/prices/moving-average?symbol=AAPL`

---

## Development

### Running Tests
To run the automated test suite, execute the following command while the application containers are running:
```bash
docker-compose exec api pytest
